<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ManuVM - P2P Online</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #121212; --accent: #00d4ff; --danger: #ff4d4d; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--primary); color: var(--text); display: flex; flex-direction: column; height: 100vh; }
        
        nav { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--accent); }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* VMs */
        .vm-section { flex: 3; padding: 15px; display: flex; flex-direction: column; }
        #vm-list { display: flex; gap: 10px; margin-bottom: 10px; }
        .vm-card { background: #1e1e1e; padding: 8px 15px; border-radius: 4px; border: 1px solid #333; cursor: pointer; }
        .iframe-container { flex: 1; background: #000; border: 1px solid #333; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Chat */
        .chat-section { flex: 1; background: #181818; border-left: 1px solid #333; display: flex; flex-direction: column; min-width: 300px; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 0.85rem; }
        .msg-admin-name { color: var(--danger) !important; font-weight: bold; }
        .msg-admin-text { color: var(--danger); }
        .chat-input-area { padding: 10px; background: #111; }
        input { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; }

        #admin-tools { display: none; background: #2a0a0a; padding: 10px; border: 1px solid var(--danger); }
        .btn-admin { background: var(--danger); color: white; border: none; padding: 5px; cursor: pointer; margin-top: 5px; width: 100%; }
    </style>
</head>
<body>

<nav>
    <h2 style="margin:0">Manu<span style="color: var(--accent);">VM</span></h2>
    <div>
        <span id="user-id-display" style="font-size: 0.7rem; color: #666;">ID: Conectando...</span> | 
        <span id="username-display" onclick="handleSecretClick()" style="cursor:pointer">Usuario</span>
    </div>
</nav>

<div class="main-container">
    <div class="vm-section">
        <div id="vm-list"></div>
        <div class="iframe-container">
            <iframe id="main-iframe"></iframe>
        </div>
    </div>

    <div class="chat-section">
        <div id="admin-tools">
            <b style="color:var(--danger)">CONSOLA ADMIN</b>
            <button class="btn-admin" onclick="addVMPrompt()">+ Añadir VM</button>
            <button class="btn-admin" onclick="clearChat()">Limpiar Chat</button>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escribe y presiona Enter..." onkeypress="if(event.key==='Enter') sendChat()">
        </div>
    </div>
</div>

<script>
    const adminPass = "manuvmonly";
    let isAdmin = false;
    let clicks = 0;
    let myUser = "User" + Math.floor(Math.random()*999);
    let vms = [];
    let peer, conn;

    // --- CONEXIÓN P2P ---
    // Usamos un ID fijo para el "Servidor" (puedes cambiar 'manuvm-host-room-1' por algo único)
    const ROOM_ID = 'manuvm-room-default-99'; 

    function initP2P() {
        peer = new Peer(); // Genera un ID aleatorio para ti

        peer.on('open', (id) => {
            document.getElementById('user-id-display').innerText = "Tu ID: " + id;
            document.getElementById('username-display').innerText = myUser;
            
            // Intentar conectar con el ID del "Host"
            connectToHost();
        });

        // Si alguien se conecta a ti (si tú eres el host)
        peer.on('connection', (c) => {
            setupConnection(c);
            // Enviar datos actuales al nuevo usuario
            setTimeout(() => {
                c.send({ type: 'sync', vms: vms });
            }, 1000);
        });
    }

    function connectToHost() {
        // En un sistema real P2P sin servidor, necesitarías el ID de tu amigo.
        // Aquí intentamos conectar a un ID manual si lo pusiéramos, 
        // pero para esta demo, usaremos el chat para sincronizar.
    }

    function setupConnection(c) {
        conn = c;
        conn.on('data', (data) => {
            if (data.type === 'chat') renderMessage(data);
            if (data.type === 'sync') { vms = data.vms; renderVMs(); }
            if (data.type === 'new-vm') { vms.push(data.vm); renderVMs(); }
        });
    }

    // --- ADMIN & SECRETS ---
    function handleSecretClick() {
        clicks++;
        if (clicks === 5) {
            if (prompt("Admin Password:") === adminPass) {
                isAdmin = true;
                document.getElementById('username-display').classList.add('msg-admin-name');
                document.getElementById('admin-tools').style.display = 'block';
                pushMessage("SISTEMA", "Modo administrador activado localmente.");
            }
            clicks = 0;
        }
    }

    // --- LOGICA DE VM ---
    function addVMPrompt() {
        const name = prompt("Nombre VM:");
        const url = prompt("URL:");
        if (name && url) {
            const newVm = { name, url };
            vms.push(newVm);
            renderVMs();
            // Aquí enviarías a los demás: peer.connections...
        }
    }

    function renderVMs() {
        const list = document.getElementById('vm-list');
        list.innerHTML = vms.map(v => `<div class="vm-card" onclick="document.getElementById('main-iframe').src='${v.url}'">${v.name}</div>`).join('');
    }

    // --- CHAT ---
    function sendChat() {
        const input = document.getElementById('chat-input');
        if (!input.value) return;
        const msg = { user: myUser, text: input.value, isAdm: isAdmin };
        renderMessage(msg);
        input.value = '';
    }

    function renderMessage(m) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<span class="${m.isAdm ? 'msg-admin-name' : ''}">${m.user}:</span> <span class="${m.isAdm ? 'msg-admin-text' : ''}">${m.text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function pushMessage(u, t) { renderMessage({user: u, text: t, isAdm: false}); }

    initP2P();
</script>
</body>
</html>
